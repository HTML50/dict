<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
	<title>dict</title>
</head>
<style type="text/css">

	*{margin:0;padding: 0;border: none}
		.dict-box{
		position: fixed;
	  width: 330px;
	  height: 400px;
		background: rgba(255,255,255,0.5);
		transform:scale(0);
		opacity: 0;
		display: none;
		left:0;
		top:0;
		transition: transform 0.5s cubic-bezier(0.46, 1.4, 0.84, 1.03),box-shadow 0.8s ease,opacity 0.8s cubic-bezier(0, 1.15, 1, 1);
	}


	.show-dictBox {
	box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  transform: scale(1);
  opacity: 1;
}

	#dictBoxBar{
		position: absolute;
		background: #eee;
		width: 100%;
		height: 42px;
		cursor: move;
    user-select: none; 
	}
	.not-pinned{
		padding: 5px;
		transition: transform 0.1s ease;
	}
	.pinned{
		transform: rotateZ(-45deg);
	}
	#injectedResultBox{
		margin-top: 15px;
	}
</style>
<body>
Hello
<br>Goood<br>Nice<br>beautiful<br>interesting<br>in your face<br>microminiaturization<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>


<dictBox id="dictBox" class="dict-box transiton-in">
<dictBoxBar id='dictBoxBar'><img id="pinOnTop" src="img/pin.png" title="pin on top" draggable="false" class="not-pinned"></dictBoxBar>
<iframe id="injectedResultBox" src="http://dict.cn/abb" scrolling="no"></iframe>
</dictBox>

<script>

var isMouseDown,
initX,initY,
dictBoxBar = document.getElementById('dictBoxBar'),
isBoxOpened = false,isPinned=false,hiddenProcess,hiddenProcessDetectProcess;

dictBoxBar.addEventListener('mousedown',function(e){
	isMouseDown = true;
	initX = e.clientX - dictBox.offsetLeft;
	initY = e.clientY - dictBox.offsetTop;
	dictBox.style.opacity = 0.5;
})

	document.addEventListener('mousemove',function(e){
		if(isMouseDown){
			dictBox.style.left = (e.clientX - initX) +'px';
			dictBox.style.top = (e.clientY - initY)+'px';
		}
	})

dictBoxBar.addEventListener('mouseup',function(){
	isMouseDown = false;
	dictBox.style.opacity = 1;
})

document.addEventListener('mouseup',function(e){
	var selectWord = getSelection().toString().trim();

	if(isBoxOpened == false){
    if(selectWord != ''){
    	dictBox.style.left = e.clientX + 20 + 'px';
    	dictBox.style.top = e.clientY + 20 + 'px';
    	dictBox.style.display = 'block';
    	setTimeout(function(){dictBox.classList.add('show-dictBox');},0)
    	isBoxOpened = true;//这个true放在lookup()下面就不管用了，难道是因为lookup是content_script中定义的缘故？我一会放在一起试试(yes it is!)
      lookup(selectWord);
      window.getSelection().collapseToStart();
    }
	}else{
		if(selectWord != ''){
			lookup(selectWord);
		}else{
			if( e.target.nodeName == 'DICTBOXBAR' || e.target.nodeName == 'IMG' || isPinned){
			return false;
		}
		dictBox.classList.remove('show-dictBox');
		hiddenProcess = setTimeout(function(){
			dictBox.style.display = 'none';
		},800);
		hiddenProcessDetectProcess = setInterval(function(){
				if(isBoxOpened){
					clearTimeout(hiddenProcess);
					clearInterval(hiddenProcessDetectProcess);
				}
			},16)
		isBoxOpened = false;
		}
	}
    
})


pinOnTop.addEventListener('click',function(e){
	if(isPinned){
		pinOnTop.classList.remove('pinned');
		isPinned = false;
	}else{
		pinOnTop.classList.add('pinned');
		isPinned = true;
	}
	//e.stopPropagation();
})

function lookup(w){
  injectedResultBox.src='http://dict.cn/'+w;
}

</script>
</body>
</html>